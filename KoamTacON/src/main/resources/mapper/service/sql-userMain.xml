<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aisolution.koamtacon.mapper.service.UserMainMapper">
    <select id="getDayEventList" resultType="HashMap">
    <![CDATA[
	SELECT 
	 			'예약불가' AS title
	 			,m.startdate AS start
	 			, null AS end
			, '#FAC2AC' AS backgroundColor
			, null AS display
			, '#000000' AS textColor
	FROM (
		WITH	recursive T as (
			    select date_format(date_add(now(), interval 1 day), '%Y-%m-%d') as startDate
			    union all
			    SELECT startDate + interval 1 day FROM T
			    where startDate < date_format(date_add(now(), INTERVAL 2 month), '%Y-%m-%d')
		)
		SELECT STARTdate 
				, DAYOFWEEK(startdate) AS day_of_week_no
		from T
		WHERE STARTdate NOT IN
		(
			WITH	recursive T1 AS (
				    select DATE_FORMAT(CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT code_name FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901')), '%Y-%m-%d') as startDate
				    union all
				    SELECT startDate + interval 1 day FROM T1 
				    where startDate < CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT description FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901'))
			)
			SELECT STARTdate from t1
		)
	) m,
	(
	SELECT description
		,(CASE description WHEN 'SUN' THEN '1' WHEN 'MON' THEN '2' WHEN 'TUE' THEN '3' WHEN 'WED' THEN '4' WHEN 'THU' THEN '5' WHEN 'FRI' THEN '6' WHEN 'SAT' THEN '7' END) AS day_of_week_no
	FROM tb_code
	WHERE master_code = 'c06' AND code_name = 'SONGDO'
	) d1
	WHERE m.day_of_week_no = d1.day_of_week_no
	
	UNION ALL
	
	SELECT 
	 			'예약불가' AS title
	 			,m.startdate AS start
	 			, null AS end
			, '#82EA84' AS backgroundColor
			, null AS display
			, '#000000' AS textColor
	FROM (
		WITH	recursive T as (
			    select date_format(date_add(now(), interval 1 day), '%Y-%m-%d') as startDate
			    union all
			    SELECT startDate + interval 1 day FROM T
			    where startDate < date_format(date_add(now(), INTERVAL 2 month), '%Y-%m-%d')
		)
		SELECT STARTdate 
				, DAYOFWEEK(startdate) AS day_of_week_no
		from T
		WHERE STARTdate NOT IN
		(
			WITH	recursive T1 AS (
				    select DATE_FORMAT(CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT code_name FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901')), '%Y-%m-%d') as startDate
				    union all
				    SELECT startDate + interval 1 day FROM T1 
				    where startDate < CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT description FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901'))
			)
			SELECT STARTdate from t1
		)
	) m,
	(
	SELECT description
		,(CASE description WHEN 'SUN' THEN '1' WHEN 'MON' THEN '2' WHEN 'TUE' THEN '3' WHEN 'WED' THEN '4' WHEN 'THU' THEN '5' WHEN 'FRI' THEN '6' WHEN 'SAT' THEN '7' END) AS day_of_week_no
	FROM tb_code
	WHERE master_code = 'c06' AND code_name = 'SOKCHO'
	) d1
	WHERE m.day_of_week_no = d1.day_of_week_no
	
	UNION ALL
	
	SELECT 
	 			'예약불가' AS title
	 			,m.startdate AS start
	 			, null AS end
			, '#9FA3F7' AS backgroundColor
			, null AS display
			, '#000000' AS textColor
	FROM (
		WITH	recursive T as (
			    select date_format(date_add(now(), interval 1 day), '%Y-%m-%d') as startDate
			    union all
			    SELECT startDate + interval 1 day FROM T
			    where startDate < date_format(date_add(now(), INTERVAL 2 month), '%Y-%m-%d')
		)
		SELECT STARTdate 
				, DAYOFWEEK(startdate) AS day_of_week_no
		from T
		WHERE STARTdate NOT IN
		(
			WITH	recursive T1 AS (
				    select DATE_FORMAT(CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT code_name FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901')), '%Y-%m-%d') as startDate
				    union all
				    SELECT startDate + interval 1 day FROM T1 
				    where startDate < CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT description FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901'))
			)
			SELECT STARTdate from t1
		)
	) m,
	(
	SELECT description
		,(CASE description WHEN 'SUN' THEN '1' WHEN 'MON' THEN '2' WHEN 'TUE' THEN '3' WHEN 'WED' THEN '4' WHEN 'THU' THEN '5' WHEN 'FRI' THEN '6' WHEN 'SAT' THEN '7' END) AS day_of_week_no
	FROM tb_code
	WHERE master_code = 'c06' AND code_name = 'JEJU'
	) d1
	WHERE m.day_of_week_no = d1.day_of_week_no

		UNION all

		SELECT 
		 	'전체 예약불가' AS title
			, CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',code_name) AS start
			, CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',description) AS end
			, '#5E5E5E' AS backgroundColor
			, 'background' AS display
			, null AS textColor
		FROM tb_code
		WHERE master_code = 'C09'
			AND use_yn = 'Y'
	
	UNION all		
			
	SELECT 
		'전체 예약불가' AS title
		,CONCAT(DATE_FORMAT(MIN(STARTdate), '%Y'),'-01-01') AS start
		, DATE_ADD(MIN(STARTdate), INTERVAL -1 DAY) AS END
		, '#5E5E5E' AS backgroundColor
		, 'background' AS display
		, null AS textColor
	FROM
	(
		WITH	recursive T as (
			    select date_format(date_add(now(), interval 1 day), '%Y-%m-%d') as startDate
			    union all
			    SELECT startDate + interval 1 day FROM T
			    where startDate < date_format(date_add(now(), INTERVAL 2 month), '%Y-%m-%d')
		)
		SELECT STARTdate 
		from T
		WHERE STARTdate NOT IN
		(
			WITH	recursive T1 AS (
				    select DATE_FORMAT(CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT code_name FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901')), '%Y-%m-%d') as startDate
				    union all
				    SELECT startDate + interval 1 day FROM T1 
				    where startDate < CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT description FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901'))
			)
			SELECT STARTdate from t1
		)
	) M
	
	UNION ALL
	
	SELECT 
		'전체 예약불가' AS title
		,DATE_ADD(MAX(STARTdate), INTERVAL 1 DAY) AS start
		, CONCAT(DATE_FORMAT(DATE_ADD(MAX(STARTdate), INTERVAL 1 YEAR), '%Y'),'-12-31') AS end
		, '#5E5E5E' AS backgroundColor
		, 'background' AS display
		, null AS textColor
	FROM
	(
		WITH	recursive T as (
			    select date_format(date_add(now(), interval 1 day), '%Y-%m-%d') as startDate
			    union all
			    SELECT startDate + interval 1 day FROM T
			    where startDate < date_format(date_add(now(), INTERVAL 2 month), '%Y-%m-%d')
		)
		SELECT STARTdate 
		from T
		WHERE STARTdate NOT IN
		(
			WITH	recursive T1 AS (
				    select DATE_FORMAT(CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT code_name FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901')), '%Y-%m-%d') as startDate
				    union all
				    SELECT startDate + interval 1 day FROM T1 
				    where startDate < CONCAT(DATE_FORMAT(NOW(), '%Y'),'-',(SELECT description FROM tb_code WHERE master_code IN ('C09') AND CODE = 'C0901'))
			)
			SELECT STARTdate from t1
		)
	) M
	
	UNION ALL
	
	/** 요청, 승인 추가분 */
	SELECT 
		 		CONCAT(cop_cd, '(',NAME, ',',(SELECT code_name FROM tb_code WHERE master_code = 'C01' AND CODE = m.res_sts_cd),')') AS title
	 			, m.sta_day AS start
	 			, m.end_day AS end
				, CASE m.place_cd WHEN 'SONGDO' THEN '#E04A0E' WHEN 'SOKCHO' THEN '#1EB422' WHEN 'JEJU' THEN '#2B34ED' END AS backgroundColor
				, null AS display
				, '#FFFFFF' AS textColor
	FROM tb_reservation m
	WHERE res_sts_cd IN ('C0102','C0104')
		AND (sta_day <= date_format(date_add(now(), INTERVAL 2 month), '%Y-%m-%d')
			OR end_day >= date_format(date_add(now(), interval 1 day), '%Y-%m-%d'))
			
    ]]>
    </select>


    <select id="getNumberOfUsers" resultType="HashMap">
    <![CDATA[
        select MAX(day_users) AS dayUsers
             , MAX(week_users) AS weekUsers
             , MAX(month_users) AS monthUsers
          from (select COUNT(0) as day_users
                     , 0 as week_users
                     , 0 as month_users
                  from tb_user
                 where 1=1
                   and DATE_FORMAT(created_date, '%Y%m%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 DAY), '%Y%m%d')
                 union all
                select 0 as day_users
                     , COUNT(0) as week_users
                     , 0 as month_users
                  from tb_user
                 where 1=1
                   and DATE_FORMAT(created_date, '%Y%m%d')  > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -7 DAY), '%Y%m%d')
                 union all
                select 0 as day_users
                     , 0 as week_users
                     , COUNT(0) as month_users
                  from tb_user
                 where 1=1
                   and DATE_FORMAT(created_date, '%Y%m%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 MONTH), '%Y%m%d')
               ) base
    ]]>
    </select>
    
    <select id="getNumberOfGroups" resultType="HashMap">
    <![CDATA[
        select MAX(day_groups) AS dayGroups
             , MAX(week_groups) AS weekGroups
             , MAX(month_groups) AS monthGroups
          from (select COUNT(0) as day_groups
                     , 0 as week_groups
                     , 0 as month_groups
                  from tb_group
                 where 1=1
                   and DATE_FORMAT(created_date, '%Y%m%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 DAY), '%Y%m%d')
                 union all
                select 0 as day_groups
                     , COUNT(0) as week_groups
                     , 0 as month_groups
                  from tb_group
                 where 1=1
                   and DATE_FORMAT(created_date, '%Y%m%d')  > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -7 DAY), '%Y%m%d')
                 union all
                select 0 as day_groups
                     , 0 as week_groups
                     , COUNT(0) as month_groups
                  from tb_group
                 where 1=1
                   and DATE_FORMAT(created_date, '%Y%m%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 MONTH), '%Y%m%d')
               ) base
    ]]>
    </select>
    
    <select id="getNumberOfKDC" resultType="HashMap">
    <![CDATA[
        select MAX(day_kdc) AS dayKdc
             , MAX(week_kdc) AS weekKdc
             , MAX(month_kdc) AS monthKdc
          from (select COUNT(0) as day_kdc
                     , 0 as week_kdc
                     , 0 as month_kdc
                  from tb_kdc_registration
                 where 1=1
                   and approval = '0'
                   and DATE_FORMAT(created_date, '%Y%m%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 DAY), '%Y%m%d')
                 union all
                select 0 as day_kdc
                     , COUNT(0) as week_kdc
                     , 0 as month_kdc
                  from tb_kdc_registration
                 where 1=1
                   and approval = '0'
                   and DATE_FORMAT(created_date, '%Y%m%d')  > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -7 DAY), '%Y%m%d')
                 union all
                select 0 as day_kdc
                     , 0 as week_kdc
                     , COUNT(0) as month_kdc
                  from tb_kdc_registration
                 where 1=1
                   and approval = '0'
                   and DATE_FORMAT(created_date, '%Y%m%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 MONTH), '%Y%m%d')
               ) base
    ]]>
    </select>
    
    <select id="getNumberOfQuestions" resultType="HashMap">
    <![CDATA[
        select MAX(day_questions) AS dayQuestions
             , MAX(week_questions) AS weekQuestions
             , MAX(month_questions) AS monthQuestions
          from (select COUNT(0) as day_questions
                     , 0 as week_questions
                     , 0 as month_questions
                  from tb_board
                 where 1=1
                   and board_type = '02'
                   and DATE_FORMAT(created_date, '%Y%m%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 DAY), '%Y%m%d')
                 union all
                select 0 as day_questions
                     , COUNT(0) as week_questions
                     , 0 as month_questions
                  from tb_board
                 where 1=1
                   and board_type = '02'
                   and DATE_FORMAT(created_date, '%Y%m%d')  > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -7 DAY), '%Y%m%d')
                 union all
                select 0 as day_questions
                     , 0 as week_questions
                     , COUNT(0) as month_questions
                  from tb_board
                 where 1=1
                   and board_type = '02'
                   and DATE_FORMAT(created_date, '%Y%m%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 MONTH), '%Y%m%d')
               ) base
    ]]>
    </select>
</mapper>